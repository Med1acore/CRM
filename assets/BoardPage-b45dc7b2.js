import{af as D,r as S,j as s,ag as C,ah as I,ai as T,aj as U,ak as A,al as P,ac as j,am as B,an as O,b as R,ao as K,ap as L,aq as M}from"./index-a21bb311.js";function q({id:w,title:l,children:i,onAddTask:c}){const{setNodeRef:u,isOver:v}=D({id:w}),[p,a]=S.useState(""),b=()=>{const m=p.trim();m&&(c==null||c(m),a(""))};return s.jsxs("div",{ref:u,className:`bg-slate-800 rounded-lg p-3 w-80 flex-shrink-0 border transition-colors min-h-[200px] ${v?"border-blue-400":"border-transparent"}`,children:[s.jsx("h2",{className:"text-lg font-semibold mb-3 text-white",children:l}),i,s.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[s.jsx("input",{value:p,onChange:m=>a(m.target.value),onKeyDown:m=>m.key==="Enter"&&b(),placeholder:"Новая задача",className:"flex-1 bg-slate-700 text-white placeholder:text-slate-400 rounded-md px-2 py-2 text-sm border border-slate-600 focus:outline-none focus:ring-1 focus:ring-blue-400"}),s.jsx("button",{onClick:b,className:"px-3 py-2 text-sm rounded-md bg-blue-600 hover:bg-blue-500 text-white",children:"+"})]})]})}function V({id:w,title:l}){const{attributes:i,listeners:c,setNodeRef:u,transform:v,transition:p,isDragging:a}=C({id:w}),b={transform:I.Transform.toString(v),transition:p,opacity:a?0:1};return s.jsx("div",{ref:u,style:b,...i,...c,className:"bg-slate-700 rounded-md p-3 mb-2 cursor-grab active:cursor-grabbing select-none text-white",children:l})}const Y=[{id:"todo",title:"Нужно сделать"},{id:"inprogress",title:"В работе"},{id:"done",title:"Готово"}];function $(){const w=T(U(L,{activationConstraint:{distance:8}})),[l,i]=S.useState([]),[c,u]=S.useState(null),[v,p]=S.useState(null);S.useEffect(()=>{let e=!0;async function r(){if(!j){u("Supabase не инициализирован: проверьте VITE_SUPABASE_URL/ANON_KEY");return}const f="f233aec4-3b13-4a2b-ae9c-50d9e7b00801",{data:d,error:t}=await j.from("tasks").select("id,title,column,created_at").eq("workspace_id",f).order("created_at",{ascending:!0});e&&(t&&(console.error("Supabase error loading tasks:",t),u(`Ошибка: ${t.message}. Проверьте .env.local (VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY)`)),!t&&d&&i(d))}return r(),()=>{e=!1}},[]);const a=S.useMemo(()=>{const e={todo:[],inprogress:[],done:[]};for(const r of l)e[r.column].push(r);return e},[l]),b=S.useMemo(()=>l.find(e=>e.id===v)||null,[l,v]),m=e=>{p(String(e.active.id))},y=async e=>{const{active:r,over:f}=e;if(p(null),!f)return;const d=String(r.id),t=String(f.id);if(d===t)return;const N=l.find(o=>o.id===d);if(!N)return;let n=null;if(t==="todo"||t==="inprogress"||t==="done")n=t;else{const o=a.todo.find(h=>h.id===t),g=a.inprogress.find(h=>h.id===t),k=a.done.find(h=>h.id===t);o?n="todo":g?n="inprogress":k&&(n="done")}if(!n)return;const x=N.column;if(x===n){const o=a[x],g=o.findIndex(E=>E.id===d),k=o.findIndex(E=>E.id===t);if(g===-1||k===-1)return;const h=M(o,g,k);i(E=>[...E.filter(_=>_.column!==x),...h])}else if(i(o=>o.map(g=>g.id===d?{...g,column:n}:g)),j){const{error:o}=await j.from("tasks").update({column:n}).eq("id",d);o&&u(o.message)}};return s.jsxs(A,{sensors:w,collisionDetection:P,onDragStart:m,onDragEnd:y,children:[c&&s.jsx("div",{className:"mb-3 text-sm text-red-300 bg-red-900/30 border border-red-700 rounded p-3",children:c}),s.jsx("div",{className:"flex gap-4 overflow-x-auto p-2",children:Y.map(e=>s.jsx(q,{id:e.id,title:e.title,onAddTask:async r=>{const f={id:crypto.randomUUID(),title:r,column:e.id};if(i(n=>[...n,f]),!j)return;const d="f233aec4-3b13-4a2b-ae9c-50d9e7b00801",{data:t,error:N}=await j.from("tasks").insert({title:r,column:e.id,workspace_id:d}).select("id,title,column,created_at").single();N?(u(N.message),i(n=>n.filter(x=>x.id!==f.id))):t&&i(n=>n.map(x=>x.id===f.id?t:x))},children:s.jsx(B,{items:a[e.id].map(r=>r.id),strategy:O,children:a[e.id].map(r=>s.jsx(V,{id:r.id,title:r.title},r.id))})},e.id))}),R.createPortal(s.jsx(K,{children:b?s.jsx("div",{className:"bg-slate-700 rounded-md p-3 text-white shadow-2xl",children:b.title}):null}),document.body)]})}function F(){return s.jsx("div",{className:"p-6",children:s.jsx($,{})})}export{F as BoardPage};
